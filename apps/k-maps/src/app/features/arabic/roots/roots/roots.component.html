<div class="roots-page">
  <app-headerbar
    class="roots-toolbar"
    [showTitle]="false"
    [showSearch]="true"
    [placeholder]="'Search root'"
    [value]="q"
    [primaryLabel]="'Add'"
    [secondaryLabel]="'Refresh'"
    (search)="onHeaderSearchInput($event)"
    (primary)="openCreate()"
    (secondary)="refresh()"
  />

  <div *ngIf="error" class="alert alert-danger py-2 my-3">
    {{ error }}
  </div>

  <div *ngIf="loading" class="text-body-secondary my-3">Loading…</div>

  <app-crud-table
    *ngIf="!loading && rows?.length"
    [columns]="tableColumns"
    [rows]="rows"
    [actions]="tableActions"
    [emptyMessage]="'No roots found.'"
    (action)="onTableAction($event)"
  ></app-crud-table>

  <app-headerbar
    class="roots-pagination-footer"
    [showTitle]="false"
    [showSearch]="false"
    [pagination]="headerPagination"
    (pageChange)="onHeaderPageChange($event)"
    (pageSizeChange)="onHeaderPageSizeChange($event)"
  />

  <div *ngIf="!loading && (!rows || !rows.length)" class="text-body-secondary my-3">
    No roots found.
  </div>

  <!-- Cards Modal -->
  <app-cards
    *ngIf="showCards"
    [id]="selectedRoot?.id"
    [root]="selectedRoot?.root ?? ''"
    [cards]="selectedCards"
    [cardsJson]="selectedCardsJson"
    [error]="cardsError"
    [saving]="savingCards"
    [initialTab]="cardsTab"
    [initialJsonMode]="cardsJsonMode"
    (close)="closeCards()"
    (saveJson)="saveCardsJson($event)"
  />

  <!-- Create Root Modal -->
  <div *ngIf="showCreate" class="roots-modal-backdrop" (click)="closeCreate()"></div>
  <div *ngIf="showCreate" class="roots-modal" (click)="$event.stopPropagation()">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h5 class="mb-0">New Root</h5>
      <button type="button" class="btn btn-sm btn-outline-secondary" (click)="closeCreate()">
        Close
      </button>
    </div>
    <div class="mb-3">
      <label class="form-label">Root</label>
      <input type="text" class="form-control" [(ngModel)]="newRoot" />
    </div>
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label class="form-label">Latin</label>
        <input type="text" class="form-control" [(ngModel)]="newRootLatn" placeholder="Z-H-D" />
      </div>
      <div class="col-md-6">
        <label class="form-label">Normalized key</label>
        <input type="text" class="form-control" [(ngModel)]="newRootNorm" placeholder="zhd" />
      </div>
    </div>
    <div class="mb-3">
      <label class="form-label">Alternate transliterations (comma-separated)</label>
      <input
        type="text"
        class="form-control"
        [(ngModel)]="newAltLatn"
        placeholder="z-h-d, ZHD, zhd"
      />
    </div>
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label class="form-label">Romanization lane</label>
        <input type="text" class="form-control" [(ngModel)]="newRomanizationLane" placeholder="z-h-d" />
      </div>
      <div class="col-md-6">
        <label class="form-label">Romanization key terms</label>
        <input type="text" class="form-control" [(ngModel)]="newRomanizationKeyTerms" placeholder="zhd" />
      </div>
    </div>
    <div class="mb-3">
      <label class="form-label">Search keys</label>
      <input
        type="text"
        class="form-control"
        [(ngModel)]="newSearchKeys"
        placeholder="auto-generated if empty"
      />
      <div class="form-text">Enter normalized terms to improve search; defaults to root+romanization.</div>
    </div>
    <div class="roots-divider"></div>
    <div class="mb-2 fw-semibold">Cards</div>
    <div class="roots-card-grid">
      <div>
        <label class="form-label">Surf</label>
        <input type="text" class="form-control" [(ngModel)]="newCardSurf" />
      </div>
      <div>
        <label class="form-label">Example</label>
        <input type="text" class="form-control" [(ngModel)]="newCardExample" />
      </div>
      <div>
        <label class="form-label">Meaning</label>
        <input type="text" class="form-control" [(ngModel)]="newCardMeaning" />
      </div>
      <div>
        <label class="form-label">Tag</label>
        <input type="text" class="form-control" [(ngModel)]="newCardTag" />
      </div>
    </div>
    <div class="d-flex justify-content-end mt-2">
      <button type="button" class="btn btn-outline-secondary btn-sm" (click)="addNewCard()">
        Add Card
      </button>
    </div>
    <div class="roots-cards-list" *ngIf="newCards.length">
      <div class="roots-cards-item" *ngFor="let c of newCards; let i = index">
        <div>
          <div class="fw-semibold">{{ c.front }}</div>
          <div class="text-body-secondary">{{ c.back }}</div>
          <div class="text-body-secondary small" *ngIf="c.tag">Tag: {{ c.tag }}</div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeNewCard(i)">
          Remove
        </button>
      </div>
    </div>
    <div class="mt-3">
      <label class="form-label">Cards JSON</label>
      <textarea class="form-control roots-json" rows="6" [value]="newCardsJson" readonly></textarea>
    </div>
    <div class="d-flex justify-content-end gap-2">
      <button type="button" class="btn btn-outline-secondary" (click)="closeCreate()">
        Cancel
      </button>
      <button type="button" class="btn btn-primary" (click)="createNew()" [disabled]="creating">
        {{ creating ? 'Creating…' : 'Create' }}
      </button>
    </div>
  </div>

</div>
