<div class="quran-text-view">
  <app-headerbar
    [showTitle]="true"
    [title]="headerTitle"
    [showSearch]="false"
    [leadingLabel]="'Back to Surah list'"
    (leading)="goBack()"
  />

  <section class="lesson-study">
    <header class="study-header single-title">
      <div class="study-title">
        <h2>{{ headerTitle }}</h2>
        <h3 *ngIf="surah">{{ surah.meta['english_name_translation'] || '—' }}</h3>
      </div>
      <p class="study-meta" *ngIf="surah">{{ surah.ayah_count || '—' }} Ayahs</p>
    </header>

    <hr class="study-divider" />

    <div *ngIf="error" class="alert alert-danger py-2">{{ error }}</div>

    <ng-container *ngIf="surah; else loadingTpl">
      <div class="study-grid">
        <article class="study-card">
          <div class="study-card-heading">
            <div class="study-card-title">
              <h4>Text</h4>
              <h4 class="study-card-mode">Surah {{ surah.surah }}</h4>
              <p class="study-card-subtitle" *ngIf="showTranslation && translationSourceMeta">
                {{ translationSourceMeta }}
              </p>
            </div>
            <div class="view-controls">
              <div class="toggle-group">
                <button
                  type="button"
                  class="toggle-btn"
                  [class.active]="viewMode === 'verse'"
                  (click)="setViewMode('verse')"
                >
                  <span class="toggle-icon">≡</span>
                  Verse by Verse
                </button>
                <button
                  type="button"
                  class="toggle-btn"
                  [class.active]="viewMode === 'reading'"
                  (click)="setViewMode('reading')"
                >
                  <span class="toggle-icon">▤</span>
                  Reading
                </button>
                <button
                  type="button"
                  class="toggle-btn"
                  [class.active]="viewMode === 'translation'"
                  (click)="setViewMode('translation')"
                >
                  <span class="toggle-icon">A</span>
                  Translation
                </button>
              </div>
            </div>
          </div>
          <hr class="study-card-divider" />

          <div class="bismillah-block" *ngIf="shouldShowBismillah">
            <div class="bismillah" *ngIf="showVerse || showReading">{{ bismillah }}</div>
            <div class="bismillah-translation" *ngIf="showTranslation">{{ bismillahTranslation }}</div>
          </div>

          <div *ngIf="loadingAyahs" class="text-body-secondary">Loading ayahs…</div>

          <div
            *ngIf="!loadingAyahs && ayahs.length > 0; else noArabic"
            class="arabic-passage"
            [class.arabic-passage--reading]="showReading"
          >
            <div
              *ngIf="showReading && readingHtml"
              class="reading-text text-arabic passage-section"
              [innerHTML]="readingHtml"
            ></div>
            <div *ngIf="showTranslation" class="translation-passages passage-section">
              <ng-container *ngIf="translationPassageList.length; else translationFallback">
                <div
                  *ngFor="let passage of translationPassageList; trackBy: trackByPassage"
                  class="translation-passage"
                >
                  <div class="translation-passage-header">
                    <span class="translation-range">{{ formatTranslationRange(passage) }}</span>
                    <span class="translation-page" *ngIf="passage.page_book">p. {{ passage.page_book }}</span>
                  </div>
                  <div class="translation-body">
                    <p class="translation-text translation-text--justified">
                      <ng-container *ngIf="getPassageSegments(passage).length; else translationTextFallback">
                        <ng-container *ngFor="let seg of getPassageSegments(passage); let isLast = last">
                          <span class="translation-number">{{ seg.number }}</span>
                          <span class="translation-segment-text">{{ seg.text }}</span>
                          <span *ngIf="!isLast"> </span>
                        </ng-container>
                      </ng-container>
                      <ng-template #translationTextFallback>{{ formatPassageText(passage.text) }}</ng-template>
                    </p>
                  </div>
                  <div class="translation-footnotes" *ngIf="getFootnotes(passage).length">
                    <button
                      type="button"
                      class="footnote-toggle"
                      (click)="toggleFootnotes(passage)"
                    >
                      Footnotes ({{ getFootnotes(passage).length }})
                      <span class="footnote-toggle-icon">
                        {{ isFootnotesOpen(passage) ? '▾' : '▸' }}
                      </span>
                    </button>
                    <div class="footnote-list" *ngIf="isFootnotesOpen(passage)">
                      <div *ngFor="let note of getFootnotes(passage)" class="footnote-item">
                        <span class="footnote-marker">{{ note.marker }}</span>
                        <span class="footnote-text">{{ note.text }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>
              <ng-template #translationFallback>
                <p class="translation-text" *ngIf="readingTranslation">{{ readingTranslation }}</p>
              </ng-template>
            </div>

            <ng-container *ngIf="showVerse">
              <div
                *ngFor="let ayah of ayahs; trackBy: trackByAyah"
                class="arabic-verse-row arabic-verse-row--editable"
                [class.arabic-verse-row--editing]="isEditingAyah(ayah)"
                (dblclick)="openLemmaEditor(ayah)"
                title="Double-click to edit tokens"
              >
                <div class="verse-text text-arabic">
                  <ng-container *ngIf="(ayah.words?.length ?? 0) > 0; else versePlainText">
                    <ng-container *ngFor="let word of ayah.words; let isLast = last; trackBy: trackByAyahWord">
                      <span
                        class="quran-word quran-word--interactive"
                        [attr.data-word-location]="word.word_location || word.location || null"
                        [attr.title]="word.word_location || word.location || null"
                      >
                        {{ getWordText(word) }}
                      </span>
                      <span *ngIf="!isLast"> </span>
                    </ng-container>
                  </ng-container>

                  <ng-template #versePlainText>{{ ayah.text_uthmani || ayah.text }}</ng-template>
                  <span class="verse-number-inline">{{ formatAyahNumber(ayah.ayah) }}</span>
                </div>
                <div class="verse-translation" *ngIf="false"></div>

                <div class="lemma-editor" *ngIf="isEditingAyah(ayah)" (dblclick)="$event.stopPropagation()">
                  <div class="lemma-editor-header">
                    <div>
                      <h5>Token editor</h5>
                      <p class="lemma-editor-subtitle">Update lemma/tokens for this verse.</p>
                    </div>
                    <div class="lemma-editor-actions">
                      <button type="button" class="btn btn-outline-light btn-sm" (click)="addLemmaEditorRow(ayah)">
                        Add Token
                      </button>
                      <button
                        type="button"
                        class="btn btn-primary btn-sm"
                        [disabled]="lemmaEditorSaving"
                        (click)="saveLemmaEditorRows(ayah)"
                      >
                        {{ lemmaEditorSaving ? 'Saving…' : 'Save' }}
                      </button>
                      <button type="button" class="btn btn-ghost btn-sm" (click)="closeLemmaEditor()">
                        Close
                      </button>
                    </div>
                  </div>

                  <div *ngIf="lemmaEditorLoading" class="text-body-secondary">Loading lemma rows…</div>
                  <div *ngIf="lemmaEditorError" class="alert alert-danger py-2">{{ lemmaEditorError }}</div>

                  <div class="lemma-editor-table" *ngIf="!lemmaEditorLoading">
                    <div class="lemma-editor-row lemma-editor-row--head">
                      <span>Token</span>
                      <span>Word (Uthmani)</span>
                      <span>Word (Simple)</span>
                      <span>Lemma ID</span>
                      <span>Lemma</span>
                      <span>Lemma Clean</span>
                      <span>Location</span>
                    </div>
                    <div class="lemma-editor-row" *ngFor="let row of lemmaEditorRows; trackBy: trackByLemmaRow">
                      <input type="number" min="1" [(ngModel)]="row.token_index" />
                      <input type="text" class="text-arabic" dir="rtl" [(ngModel)]="row.word_diacritic" />
                      <input type="text" class="text-arabic" dir="rtl" [(ngModel)]="row.word_simple" />
                      <input type="number" min="1" [(ngModel)]="row.lemma_id" />
                      <input type="text" class="text-arabic" dir="rtl" [(ngModel)]="row.lemma_text" />
                      <input type="text" [(ngModel)]="row.lemma_text_clean" />
                      <span class="lemma-editor-location">{{ getEditorWordLocation(row, ayah) }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>

          <ng-template #noArabic>
            <p class="text-muted">Arabic text is not available for this surah yet.</p>
          </ng-template>
        </article>
      </div>
    </ng-container>
  </section>

  <ng-template #loadingTpl>
    <div *ngIf="loadingSurah" class="loading text-muted">Loading study data…</div>
  </ng-template>
</div>
