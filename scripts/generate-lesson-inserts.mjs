#!/usr/bin/env node

import fs from 'node:fs';
import path from 'node:path';

const baseDir = process.cwd();
const defaultInput = path.join(baseDir, 'database/data/quran/S12');
const defaultOutput = path.join(baseDir, 'database/migrations/insert-quran-s12-lessons.sql');

const inputDir = path.resolve(process.argv[2] ?? defaultInput);
const outputPath = path.resolve(process.argv[3] ?? defaultOutput);

if (!fs.existsSync(inputDir) || !fs.statSync(inputDir).isDirectory()) {
  console.error(`Input directory not found: ${inputDir}`);
  process.exit(1);
}

const files = fs
  .readdirSync(inputDir)
  .filter((file) => file.toLowerCase().endsWith('.json'))
  .sort();

if (!files.length) {
  console.error(`No JSON lesson files found inside ${inputDir}`);
  process.exit(1);
}

const sanitize = (value) => {
  if (value === undefined || value === null) return 'NULL';
  if (typeof value === 'number') {
    if (!Number.isFinite(value)) return 'NULL';
    return value;
  }
  const str = String(value).replace(/'/g, "''");
  return `'${str}'`;
};

const statements = files.map((file) => {
  const raw = fs.readFileSync(path.join(inputDir, file), 'utf8');
  const lesson = JSON.parse(raw);
  const title = lesson.title ?? file;
  const titleAr = lesson.title_ar ?? null;
  const lessonType = lesson.lesson_type ?? 'quran';
  const subtype = lesson.subtype ?? null;
  const status = lesson.status ?? 'draft';
  const difficulty = Number.isFinite(lesson.difficulty) ? lesson.difficulty : null;
  const source = lesson.reference?.ref_label ?? lesson.id ?? null;
  const lessonJson = JSON.stringify(lesson);

  const values = [
    sanitize(title),
    sanitize(titleAr),
    sanitize(lessonType),
    sanitize(subtype),
    sanitize(status),
    difficulty === null ? 'NULL' : difficulty,
    sanitize(source),
    sanitize(lessonJson),
  ];

  return `INSERT INTO ar_lessons (title, title_ar, lesson_type, subtype, status, difficulty, source, lesson_json)\nVALUES (${values.join(', ')});`;
});

const header = [
  '-- Auto-generated insert script for Quran S12 lessons.',
  `-- Source directory: ${inputDir}`,
  '-- Generated by scripts/generate-lesson-inserts.mjs',
  'PRAGMA foreign_keys = OFF;',
  'BEGIN TRANSACTION;',
];

const footer = ['COMMIT;'];

const output = [...header, '', ...statements, '', ...footer].join('\n') + '\n';

fs.writeFileSync(outputPath, output, 'utf8');
console.log(`Wrote ${statements.length} INSERT statements to ${outputPath}`);
